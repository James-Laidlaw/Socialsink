{% extends "main/header.html" %}
{% block content %}
    {% include 'main/includes/navbar.html' %}
    <div class="home-wrapper">
        <div class="left-bar">
            {% include 'main/includes/profilebar.html' %}
        </div>
        <div class="main-area">
            {% include 'main/includes/createpost.html' %}
            <div id="post-container">
                {% for post in posts %}
                    {% include 'main/includes/feedpost.html' with post=post %}
                {% endfor %}
            </div>
        </div>
        <div class="right-bar"></div>
    </div>

    <script>
        const feedContainer = document.getElementById("post-container");
        var oldPostsRetrieved = false
        var posts = 10 //Change this value if we want more posts
        var postIDs = []

        function addPost(post) {
            postIDs.push(post[0])

            if (posts === 0) {
                container.removeChild(container.lastChild)
                postIDs.shift()
                posts = posts + 1

            }
            
            console.log(post)
            console.log("post-block-" + post[0])

            const postElement = document.createElement("div");
            postElement.classList.add("feed-post", "existing-post");
            postElement.id = "post-block-" + post[0];
            postElement.setAttribute('data-post-id', post[0]);

            var likeButton = ''
            if (post[5] === 1) {
                likeButton = `<button type="button" class="btn btn-like liked" id="like-button-${post[0]}" onclick="unlikePost(${post[0]})">${post[4]} <i class="fa-solid fa-heart"></i>Like</button>`
            } else {
                likeButton = `<button type="button" class="btn btn-like" id="like-button-${post[0]}" onclick="likePost(${post[0]})">${post[4]} <i class="fa-solid fa-heart"></i>Like</button>`
            }

            // Construct the post content using the provided data
            postElement.innerHTML = `
                <a href="/"><img src="../../../static/images/unknown_user.png" /></a>
                <div class="post-content">
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa-solid fa-ellipsis"></i>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </div>
                    <div class="post-body">
                        <p id="post-username">${post[1]}</p>
                        <time id="post-timestamp">${post[2]}</time>
                        <p id="post-content">${post[3]}</p>
                    </div>
                    <div class="post-btn-wrap">
                        ${likeButton}
                        <button type="submit" class="btn btn-share"><i class="fa-solid fa-share"></i>Share</button>
                    </div>
                </div>
            `;

            // Get the container where you want to insert the new post
            if (feedContainer.firstChild) {
                feedContainer.insertBefore(postElement, feedContainer.firstChild);
            } else {
                feedContainer.appendChild(postElement)
            }

            console.log("Post added", postElement) 
            
            posts = posts - 1
        }

        $(document).ready(function() {
            function displayOldPosts() {
                $.ajax({
                    type: "GET",
                    url: "/api/get-old-available-posts/",
                    dataType: 'json',
                    success: function (response, textStatus, http) {
                        if (http.status === 200) {
                            console.log("Getting the 10 most recent posts", response)
                            for (const post in response) {
                                addPost(response[post])
                            }
                            oldPostsRetrieved = true
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                })
            }

            displayOldPosts();
        })

        function retrievePosts() {
            if (oldPostsRetrieved) {
                $.ajax({
                    type: "GET",
                    url: "/api/get-new-available-posts/",
                    dataType: 'json',
                    success: function (response, textStatus, http) {
                        if (http.status === 200) {
                            console.log("New posts coming in", response)
                            for (const post in response) {
                                addPost(response[post])
                            }
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                })
            }
        }
        setInterval(retrievePosts, 5000)

        function likePost(postID) {
            console.log("Liking post")
            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "POST",
                url: `/api/like-post/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 201) {
                        $(`#like-button-${postID}`).addClass('liked')
                        document.getElementById(`like-button-${postID}`).setAttribute('onclick', `unlikePost(${postID})`)
                        updateLikeCount(postID)
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        function unlikePost(postID) {
            console.log("Unliking Post")
            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "DELETE",
                url: `/api/unlike-post/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        console.log(response)
                        $(`#like-button-${postID}`).removeClass('liked')
                        document.getElementById(`like-button-${postID}`).setAttribute('onclick', `likePost(${postID})`)
                        updateLikeCount(postID)
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        function updateAllPosts() {
            for (const postID in postIDs) {
                updateLikeCount(postIDs[postID])
            }
        }
        setInterval(updateAllPosts, 30000) //30 second refresh

        function updateLikeCount(postID) {
            console.log("Updating like count")
            $.ajax({
                type: "GET",
                url: `/api/get-like-count/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 201) {
                        console.log(response)
                        document.getElementById(`like-button-${postID}`).innerHTML = `${response['count']} <i class="fa-solid fa-heart"></i>Like`
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }
    </script>
{% endblock content %}