{% extends "main/header.html" %}
{% block content %}
    {% include 'main/includes/navbar.html' %}
    <div class="home-wrapper">
        <div class="left-bar">
            {% include 'main/includes/profilebar.html' %}
        </div>
        <div class="main-area">
            {% include 'main/includes/createpost.html' %}
            <div id="post-container">
                {% for post in posts %}
                    {% include 'main/includes/feedpost.html' with post=post %}
                {% endfor %}
            </div>
        </div>
        <div class="right-bar"></div>
    </div>

    <div id="confirm-dialog" class="popup-modal hidden">
        <p>Are you sure you want to permanantly delete this post?</p>
        <div class="button-wrap">
            <button id="confirm-yes">Yes</button>
            <button id="confirm-no">No</button>
        </div>
    </div>

    <script>
        const feedContainer = document.getElementById("post-container");
        var oldPostsRetrieved = false
        var posts = 10 //Change this value if we want more posts
        var postIDs = []

        function addPost(post) {
            postIDs.push(post[0])

            if (posts === 0) {
                container.removeChild(container.lastChild)
                postIDs.shift()
                posts = posts + 1
            }
            
            console.log(post)
            console.log("post-block-" + post[0])

            const postElement = document.createElement("div");
            postElement.classList.add("feed-post", "existing-post");
            postElement.id = "post-block-" + post[0];
            postElement.setAttribute('data-post-id', post[0]);

            var likeButton = ''
            if (post[5] === 1) {
                likeButton = `<button type="button" class="btn btn-like liked" id="like-button-${post[0]}" onclick="unlikePost(${post[0]})">${post[4]} <i class="fa-solid fa-heart"></i></button>`
            } else {
                likeButton = `<button type="button" class="btn btn-like" id="like-button-${post[0]}" onclick="likePost(${post[0]})">${post[4]} <i class="fa-solid fa-heart"></i></button>`
            }

            if (post[6] === 1) {
                deleteButton = `<button type="button" class="btn" id="delete-button-${post[0]}" onclick="showDeleteConfirmation(${post[0]})"><i class="fa-solid fa-trash"></i>Delete</button>`
                dropdown = `<div class="dropdown-item" style="cursor: pointer" onclick="editPost(${post[0]})">Edit Post</div>`
            } else {
                deleteButton = ""
                dropdown = `<a class="dropdown-item" href="#">Non owner action</a>`
            }

            if (post[7] === true) {
                edited = ` - Edited`
            } else {
                edited = ''
            }

            // Construct the post content using the provided data
            postElement.innerHTML = `
                <a href="/"><img src="../../../static/images/unknown_user.png" /></a>
                <div class="post-content">
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-${post[0]}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa-solid fa-ellipsis"></i>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            ${dropdown}
                        </div>
                    </div>
                    <div class="post-body">
                        <p id="post-username-${post[0]}">${post[1]}</p>
                        <time id="post-timestamp-${post[0]}">${post[2]}${edited}</time>
                        <p id="post-content-${post[0]}">${post[3]}</p>
                    </div>
                    <div class="post-btn-wrap" id="post-btn-wrap-${post[0]}">
                        ${likeButton}
                        <button type="submit" id="share-button-${post[0]}" class="btn btn-share"><i class="fa-solid fa-share"></i>Share</button>
                        ${deleteButton}
                    </div>
                </div>
            `;

            // Get the container where you want to insert the new post
            if (feedContainer.firstChild) {
                feedContainer.insertBefore(postElement, feedContainer.firstChild);
            } else {
                feedContainer.appendChild(postElement)
            }

            console.log("Post added", postElement) 
            
            posts = posts - 1
        }

        $(document).on('click', '.dropdown-toggle', function () {
            var dropdown = $(this).siblings('.dropdown-menu');
            $('.dropdown-menu').not(dropdown).removeClass('show');
            dropdown.toggleClass('show');
        });
    
        // Close dropdown when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.dropdown').length) {
                $('.dropdown-menu').removeClass('show');
            }
        });

        function editPost(id) {
            console.log("Editing")

            if ($(`#like-button-${id}`).hasClass('hide') === false) {
                currentText = $(`#post-content-${id}`).text()

                $(`#post-content-${id}`).text("")

                editBox = `<input type="text" id="edit-post-text-${id}" class="form-control" aria-label="What's happening?" name="status" value="">`
                
                $(`#post-content-${id}`).append(editBox)
                $(`#edit-post-text-${id}`).val(currentText)

                saveButton = `<button type="button" class="btn" id="save-button-${id}" onclick="saveEditPost(${id})"><i class="fa-solid fa-trash"></i>Save</button>`
                cancelButton = `<button type="button" class="btn" id="cancel-button-${id}" onclick="cancelEditPost(${id}, '${currentText}')"><i class="fa-solid fa-trash"></i>Cancel</button>`
                $(`#post-btn-wrap-${id}`).append(saveButton)
                $(`#post-btn-wrap-${id}`).append(cancelButton)
                
                $(`#like-button-${id}`).addClass('hide')
                $(`#share-button-${id}`).addClass('hide')
                $(`#delete-button-${id}`).addClass('hide')
            }
        }

        function saveEditPost(id) {
            console.log("Saved")

            currentText = $(`#edit-post-text-${id}`).val()
            console.log(currentText)

            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "PUT",
                url: `/api/update-post-data/${id}`,
                contentType: 'application/json',
                data: JSON.stringify({
                    'text': currentText
                }),
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        $(`#save-button-${id}`).remove()
                        $(`#cancel-button-${id}`).remove()
                        $(`#edit-post-text-${id}`).remove()
                        $(`#post-content-${id}`).text(currentText)

                        $(`#like-button-${id}`).removeClass('hide')
                        $(`#share-button-${id}`).removeClass('hide')
                        $(`#delete-button-${id}`).removeClass('hide')

                        current = $(`#post-timestamp-${id}`).text()
                        $(`#post-timestamp-${id}`).text(`${current} - Edited`)
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        function cancelEditPost(id, currentText) {
            console.log("Canceled")
            $(`#post-content-${id}`).show()
            $(`#edit-post-text-${id}`).remove()
            $(`#post-content-${id}`).text(currentText)

            $(`#save-button-${id}`).remove()
            $(`#cancel-button-${id}`).remove()
            $(`#like-button-${id}`).removeClass('hide')
            $(`#share-button-${id}`).removeClass('hide')
            $(`#delete-button-${id}`).removeClass('hide')
        }

        function showDeleteConfirmation(postID) {
            // Set a global variable to store the post ID to be deleted
            window.postToDelete = postID;

            // Show the custom confirmation dialog
            $("#confirm-dialog").removeClass("hidden");
        }

        $("#confirm-yes").click(function() {
            // Execute the post deletion logic when the user clicks "Yes"
            deletePost(window.postToDelete);
            $("#confirm-dialog").addClass("hidden");
        });

        $("#confirm-no").click(function() {
            // Cancel the post deletion action when the user clicks "No"
            $("#confirm-dialog").addClass("hidden");
        });

        function deletePost(postID) {

            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "DELETE",
                url: `/api/delete-post/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        console.log(response)
                        $(`#post-block-${postID}`).remove()
                        postIDs = postIDs.filter(item => item !== postID);
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        //If the document is freshly loaded
        $(document).ready(function() {
            function displayOldPosts() {
                $.ajax({
                    type: "GET",
                    url: "/api/get-old-available-posts/",
                    dataType: 'json',
                    success: function (response, textStatus, http) {
                        if (http.status === 200) {
                            console.log("Getting the 10 most recent posts", response)
                            for (const post in response) {
                                addPost(response[post])
                            }
                            oldPostsRetrieved = true
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                })
            }

            displayOldPosts();
        })

        function retrievePosts() {
            if (oldPostsRetrieved) {
                $.ajax({
                    type: "GET",
                    url: "/api/get-new-available-posts/",
                    dataType: 'json',
                    success: function (response, textStatus, http) {
                        if (http.status === 200) {
                            console.log("New posts coming in", response)
                            for (const post in response) {
                                addPost(response[post])
                            }
                        }
                    },
                    error: function (error) {
                        console.error(error);
                    }
                })
            }
        }
        setInterval(retrievePosts, 5000)

        function likePost(postID) {
            console.log("Liking post")
            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "POST",
                url: `/api/like-post/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 201) {
                        $(`#like-button-${postID}`).addClass('liked')
                        document.getElementById(`like-button-${postID}`).setAttribute('onclick', `unlikePost(${postID})`)
                        updatePostData(postID)
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        function unlikePost(postID) {
            console.log("Unliking Post")
            var csrf_token = "{{ csrf_token }}";
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrf_token);
                    }
                }
            });
            $.ajax({
                type: "DELETE",
                url: `/api/unlike-post/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        $(`#like-button-${postID}`).removeClass('liked')
                        document.getElementById(`like-button-${postID}`).setAttribute('onclick', `likePost(${postID})`)
                        updatePostData(postID)
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }

        function updateAllPosts() {
            console.log("Fetching new like counts if theres changes")
            for (const postID in postIDs) {
                updatePostData(postIDs[postID])
            }
        }
        setInterval(updateAllPosts, 5000) //5 second refresh

        function checkForDeletedPosts() {
            $.ajax({
                type: "GET",
                url: `/api/get-deleted-posts/`,
                contentType: 'application/json',
                data: {
                    ids: postIDs
                },
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        console.log(response)
                        for (const post in response) {
                            $(`#post-block-${response[post]}`).remove()
                            postIDs = postIDs.filter(item => item !== response[post]);
                        }
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }
        setInterval(checkForDeletedPosts, 5000) //5 second refresh

        function updatePostData(postID) {
            console.log("Updating the post")
            $.ajax({
                type: "GET",
                url: `/api/get-post-data/${postID}`,
                success: function (response, textStatus, http) {
                    if (http.status === 200) {
                        console.log(response)
                        document.getElementById(`like-button-${postID}`).innerHTML = `${response['count']} <i class="fa-solid fa-heart"></i>`
                        if ($(`#post-content-${postID}`).children().length === 0) {
                            $(`#post-content-${postID}`).text(response['content'])
                        }
                        current = $(`#post-timestamp-${postID}`).text()
                        if (response['edited'] === true && current.includes("Edited") === false) {
                            $(`#post-timestamp-${postID}`).text(`${current} - Edited`)
                        }
                    }
                },
                error: function (error) {
                    console.error(error);
                }
            })
        }
    </script>
{% endblock content %}